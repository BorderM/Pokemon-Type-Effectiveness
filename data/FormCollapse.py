import json
import os
import logging
from collections import defaultdict

logger = logging.getLogger(__name__)

ROOT = os.path.abspath(os.path.join(os.path.dirname(__file__), '..'))
CACHE = os.path.join(ROOT, 'processed_pokemon_cache.json')
with open(CACHE, encoding='utf-8') as f:
    data = json.load(f)

FORMS = []
for entry in data:
    species = entry.get('species') or entry['name'].split('-, 1')[0]  
    form_name = entry.get('form_name') or (entry['name'].split('-',1)[1] if '-' in entry['name'] else '')
    FORMS.append({
        'key':        entry['name'],
        'species':    species,
        'form_name':  form_name,
        'sprite_url': entry.get('sprite_url',''),
        'pokeapi_id': entry.get('id'),
    })

FORM_COLLAPSE_MAP = {
    "abomasnow-mega": "abomasnow-mega",
    "absol-mega": "absol-mega",
    "aegislash-blade": "Aegislash-blade",
    "aegislash-shield": "aegislash-blade",
    "aerodactyl-mega": "aerodactyl-mega",
    "aggron-mega": "aggron-mega",
    "alakazam-mega": "alakazam-mega",
    "alcremie-gmax": "Alcremie",
    "altaria-mega": "altaria-mega",
    "ampharos-mega": "ampharos-mega",
    "appletun-gmax": "Appletun",
    "araquanid-totem": "Delete",
    "arcanine-hisui": "arcanine-hisui",
    "articuno-galar": "articuno-galar",
    "audino-mega": "audino-mega",
    "avalugg-hisui": "avalugg-hisui",
    "banette-mega": "banette-mega",
    "basculin-blue-striped": "basculin-white-striped",
    "basculin-red-striped": "basculin-white-striped",
    "basculin-white-striped": "basculin-white-striped",
    "beedrill-mega": "beedrill-mega",
    "blastoise-gmax": "Blastoise",
    "blastoise-mega": "blastoise-mega",
    "blaziken-mega": "blaziken-mega",
    "braviary-hisui": "braviary-hisui",
    "brute-bonnet": "brute-bonnet",
    "butterfree-gmax": "Butterfree",
    "calyrex-ice": "calyrex-ice",
    "calyrex-shadow": "calyrex-shadow",
    "camerupt-mega": "camerupt-mega",
    "castform-rainy": "castform-rainy",
    "castform-snowy": "castform-snowy",
    "castform-sunny": "castform-sunny",
    "centiskorch-gmax": "centiskorch",
    "charizard-gmax": "Charizard",
    "charizard-mega-x": "charizard-mega-x",
    "charizard-mega-y": "charizard-mega-y",
    "chi-yu": "chi-yu",
    "chien-pao": "chien-pao",
    "cinderace-gmax": "Cinderace",
    "coalossal-gmax": "coalossal",
    "copperajah-gmax": "copperajah",
    "corsola-galar": "corsola-galar",
    "corviknight-gmax": "corviknight",
    "cramorant-gorging": "Cramorant",
    "cramorant-gulping": "Cramorant",
    "darmanitan-galar-standard": "darmanitan-galar-standard",
    "darmanitan-galar-zen": "darmanitan-galar-standard",
    "darmanitan-standard": "Darmanitan-standard",
    "darmanitan-zen": "Darmanitan-standard",
    "darumaka-galar": "darumaka-galar",
    "decidueye-hisui": "decidueye-hisui",
    "deoxys-attack": "deoxys-normal",
    "deoxys-defense": "deoxys-normal",
    "deoxys-normal": "deoxys-normal",
    "deoxys-speed": "deoxys-normal",
    "dialga-origin": "Dialga",
    "diancie-mega": "diancie-mega",
    "diglett-alola": "diglett-alola",
    "drednaw-gmax": "drednaw",
    "dudunsparce-two-segment": "dudunsparce-two-segment",
    "dudunsparce-three-segment": "dudunsparce-two-segment",
    "dugtrio-alola": "dugtrio-alola",
    "duraludon-gmax": "duraludon",
    "eevee-gmax": "Eevee",
    "eevee-starter": "Eevee",
    "eiscue-ice": "Eiscue",
    "eiscue-noice": "Eiscue",
    "electrode-hisui": "electrode-hisui",
    "enamorus-incarnate": "enamorus-incarnate",
    "enamorus-therian": "enamorus-incarnate",
    "eternatus-eternamax": "eternatus-eternamax",
    "exeggutor-alola": "exeggutor-alola",
    "farfetchd-galar": "farfetchd-galar",
    "flapple-gmax": "flapple",
    "floette-eternal": "Floette",
    "flutter-mane": "flutter-mane",
    "gallade-mega": "gallade-mega",
    "garbodor-gmax": "garbodor",
    "garchomp-mega": "garchomp-mega",
    "gardevoir-mega": "gardevoir-mega",
    "gengar-gmax": "gengar",
    "gengar-mega": "gengar-mega",
    "geodude-alola": "geodude-alola",
    "gimmighoul-roaming": "Gimmighoul",
    "giratina-altered": "giratina-altered",
    "giratina-origin": "giratina-altered",
    "glalie-mega": "glalie-mega",
    "golem-alola": "golem-alola",
    "goodra-hisui": "goodra-hisui",
    "gouging-fire": "gouging-fire",
    "gourgeist-average": "gourgeist-average",
    "gourgeist-large": "gourgeist-average",
    "gourgeist-small": "gourgeist-average",
    "gourgeist-super": "gourgeist-average",
    "graveler-alola": "graveler-alola",
    "great-tusk": "great-tusk",
    "greninja-ash": "Greninja",
    "greninja-battle-bond": "Greninja",
    "grimer-alola": "grimer-alola",
    "grimmsnarl-gmax": "grimmsnarl",
    "groudon-primal": "groudon-primal",
    "growlithe-hisui": "growlithe-hisui",
    "gumshoos-totem": "Delete",
    "gyarados-mega": "gyarados-mega",
    "hakamo-o": "hakamo-o",
    "hatterene-gmax": "hatterene",
    "heracross-mega": "heracross-mega",
    "ho-oh": "ho-oh",
    "hoopa-unbound": "hoopa-unbound",
    "houndoom-mega": "houndoom-mega",
    "inteleon-gmax": "inteleon",
    "iron-boulder": "iron-boulder",
    "iron-bundle": "iron-bundle",
    "iron-crown": "iron-crown",
    "iron-hands": "iron-hands",
    "iron-jugulis": "iron-jugulis",
    "iron-leaves": "iron-leaves",
    "iron-moth": "iron-moth",
    "iron-thorns": "iron-thorns",
    "iron-treads": "iron-treads",
    "iron-valiant": "iron-valiant",
    "jangmo-o": "jangmo-o",
    "kangaskhan-mega": "kangaskhan-mega",
    "keldeo-ordinary": "keldeo-ordinary",
    "keldeo-resolute": "keldeo-ordinary",
    "kingler-gmax": "kingler",
    "kommo-o": "kommo-o",
    "kommo-o-totem": "Delete",
    "koraidon-gliding-build": "Koraidon",
    "koraidon-limited-build": "Koraidon",
    "koraidon-sprinting-build": "Koraidon",
    "koraidon-swimming-build": "Koraidon",
    "kyogre-primal": "kyogre-primal",
    "kyurem-black": "Kyurem",
    "kyurem-white": "Kyurem",
    "landorus-incarnate": "landorus-incarnate",
    "landorus-therian": "landorus-incarnate",
    "lapras-gmax": "lapras",
    "latias-mega": "latias-mega",
    "latios-mega": "latios-mega",
    "lilligant-hisui": "lilligant-hisui",
    "linoone-galar": "linoone-galar",
    "lopunny-mega": "lopunny-mega",
    "lucario-mega": "lucario-mega",
    "lurantis-totem": "Delete",
    "lycanroc-dusk": "lycanroc-dusk",
    "lycanroc-midday": "lycanroc-midday",
    "lycanroc-midnight": "lycanroc-midnight",
    "machamp-gmax": "machamp",
    "magearna-original": "Magearna",
    "manectric-mega": "manectric-mega",
    "marowak-alola": "marowak-alola",
    "marowak-totem": "Delete",
    "maushold-family-of-three": "maushold-family-of-three",
    "mawile-mega": "mawile-mega",
    "medicham-mega": "medicham-mega",
    "melmetal-gmax": "melmetal",
    "meloetta-aria": "meloetta-aria",
    "meloetta-pirouette": "meloetta-pirouette",
    "meowth-alola": "meowth-alola",
    "meowth-galar": "meowth-galar",
    "meowth-gmax": "meowth",
    "metagross-mega": "metagross-mega",
    "mewtwo-mega-x": "mewtwo-mega-x",
    "mewtwo-mega-y": "mewtwo-mega-y",
    "mime-jr": "mime-jr",
    "mimikyu-busted": "mimikyu-disguised",
    "mimikyu-disguised": "mimikyu-disguised",
    "mimikyu-totem-busted": "Delete",
    "mimikyu-totem-disguised": "Delete",
    "minior-blue": "minior-blue-meteor",
    "minior-blue-meteor": "minior-blue-meteor",
    "minior-green": "minior-blue-meteor",
    "minior-green-meteor": "minior-blue-meteor",
    "minior-indigo": "minior-blue-meteor",
    "minior-indigo-meteor": "minior-blue-meteor",
    "minior-orange": "minior-blue-meteor",
    "minior-orange-meteor": "minior-blue-meteor",
    "minior-red": "minior-blue-meteor",
    "minior-red-meteor": "minior-blue-meteor",
    "minior-violet": "minior-blue-meteor",
    "minior-violet-meteor": "minior-blue-meteor",
    "minior-yellow": "minior-blue-meteor",
    "minior-yellow-meteor": "minior-blue-meteor",
    "miraidon-aquatic-mode": "Miraidon",
    "miraidon-drive-mode": "Miraidon",
    "miraidon-glide-mode": "Miraidon",
    "miraidon-low-power-mode": "Miraidon",
    "moltres-galar": "moltres-galar",
    "morpeko-full-belly": "morpeko-full-belly",
    "morpeko-hangry": "morpeko-full-belly",
    "mr-mime": "mr-mime",
    "mr-mime-galar": "mr-mime-galar",
    "mr-rime": "mr-rime",
    "muk-alola": "muk-alola",
    "necrozma-dawn": "necrozma-dawn",
    "necrozma-dusk": "necrozma-dusk",
    "necrozma-ultra": "necrozma-ultra",
    "nidoran-f": "nidoran-f",
    "nidoran-m": "nidoran-m",
    "ninetales-alola": "ninetales-alola",
    "ogerpon-cornerstone-mask": "ogerpon-cornerstone-mask",
    "ogerpon-hearthflame-mask": "ogerpon-hearthflame-mask",
    "ogerpon-wellspring-mask": "ogerpon-wellspring-mask",
    "orbeetle-gmax": "orbeetle",
    "oricorio-baile": "oricorio-baile",
    "oricorio-pau": "oricorio-pau",
    "oricorio-pom-pom": "oricorio-pom-pom",
    "oricorio-sensu": "oricorio-sensu",
    "palafin-hero": "Palafin-hero",
    "palkia-origin": "palkia",
    "persian-alola": "persian-alola",
    "pidgeot-mega": "pidgeot-mega",
    "pikachu-alola-cap": "Pikachu",
    "pikachu-belle": "Pikachu",
    "pikachu-cosplay": "Pikachu",
    "pikachu-gmax": "Pikachu",
    "pikachu-hoenn-cap": "Pikachu",
    "pikachu-kalos-cap": "Pikachu",
    "pikachu-libre": "Pikachu",
    "pikachu-original-cap": "Pikachu",
    "pikachu-partner-cap": "Pikachu",
    "pikachu-phd": "Pikachu",
    "pikachu-pop-star": "Pikachu",
    "pikachu-rock-star": "Pikachu",
    "pikachu-sinnoh-cap": "Pikachu",
    "pikachu-starter": "Pikachu",
    "pikachu-unova-cap": "Pikachu",
    "pikachu-world-cap": "Pikachu",
    "pinsir-mega": "pinsir-mega",
    "ponyta-galar": "ponyta-galar",
    "porygon-z": "porygon-z",
    "pumpkaboo-average": "pumpkaboo-average",
    "pumpkaboo-large": "pumpkaboo-average",
    "pumpkaboo-small": "pumpkaboo-average",
    "pumpkaboo-super": "pumpkaboo-average",
    "qwilfish-hisui": "qwilfish-hisui",
    "raging-bolt": "raging-bolt",
    "raichu-alola": "raichu-alola",
    "rapidash-galar": "rapidash-galar",
    "raticate-alola": "raticate-alola",
    "raticate-totem": "Delete",
    "raticate-totem-alola": "Delete",
    "rattata-alola": "rattata-alola",
    "rayquaza-mega": "rayquaza-mega",
    "ribombee-totem": "Delete",
    "rillaboom-gmax": "rillaboom",
    "roaring-moon": "roaring-moon",
    "rockruff-own-tempo": "Rockruff",
    "rotom-fan": "rotom-fan",
    "rotom-frost": "rotom-frost",
    "rotom-heat": "rotom-heat",
    "rotom-mow": "rotom-mow",
    "rotom-wash": "rotom-wash",
    "sableye-mega": "sableye-mega",
    "salamence-mega": "salamence-mega",
    "salazzle-totem": "Delete",
    "samurott-hisui": "samurott-hisui",
    "sandaconda-gmax": "sandaconda",
    "sandshrew-alola": "sandshrew-alola",
    "sandslash-alola": "sandslash-alola",
    "sandy-shocks": "sandy-shocks",
    "sceptile-mega": "sceptile-mega",
    "scizor-mega": "scizor-mega",
    "scream-tail": "scream-tail",
    "sharpedo-mega": "sharpedo-mega",
    "shaymin-land": "shaymin-land",
    "shaymin-sky": "shaymin-sky",
    "sliggoo-hisui": "sliggoo-hisui",
    "slither-wing": "slither-wing",
    "slowbro-galar": "slowbro-galar",
    "slowbro-mega": "slowbro-mega",
    "slowking-galar": "slowking-galar",
    "slowpoke-galar": "slowpoke-galar",
    "sneasel-hisui": "sneasel-hisui",
    "snorlax-gmax": "snorlax",
    "squawkabilly-blue-plumage": "squawkabilly-blue-plumage",
    "squawkabilly-white-plumage": "squawkabilly-blue-plumage",
    "squawkabilly-yellow-plumage": "squawkabilly-blue-plumage",
    "steelix-mega": "steelix-mega",
    "stunfisk-galar": "stunfisk-galar",
    "swampert-mega": "swampert-mega",
    "tapu-bulu": "tapu-bulu",
    "tapu-fini": "tapu-fini",
    "tapu-koko": "tapu-koko",
    "tapu-lele": "tapu-lele",
    "tatsugiri-droopy": "tatsugiri-droopy",
    "tatsugiri-stretchy": "tatsugiri-droopy",
    "tauros-paldea-aqua-breed": "tauros-paldea-aqua-breed",
    "tauros-paldea-blaze-breed": "tauros-paldea-blaze-breed",
    "tauros-paldea-combat-breed": "tauros-paldea-combat-breed",
    "terapagos-stellar": "terapagos",
    "terapagos-terastal": "terapagos",
    "thundurus-incarnate": "thundurus-incarnate",
    "thundurus-therian": "thundurus-incarnate",
    "ting-lu": "ting-lu",
    "togedemaru-totem": "Delete",
    "tornadus-incarnate": "tornadus-incarnate",
    "tornadus-therian": "tornadus-incarnate",
    "toxtricity-amped": "toxtricity-amped",
    "toxtricity-amped-gmax": "toxtricity-amped",
    "toxtricity-low-key": "toxtricity-amped",
    "toxtricity-low-key-gmax": "toxtricity-amped",
    "type-null": "type-null",
    "typhlosion-hisui": "typhlosion-hisui",
    "tyranitar-mega": "tyranitar-mega",
    "ursaluna-bloodmoon": "Ursaluna",
    "urshifu-rapid-strike": "urshifu-rapid-strike",
    "urshifu-rapid-strike-gmax": "urshifu-rapid-strike",
    "urshifu-single-strike": "urshifu-single-strike",
    "urshifu-single-strike-gmax": "urshifu-single-strike",
    "venusaur-gmax": "Venusaur",
    "venusaur-mega": "venusaur-mega",
    "vikavolt-totem": "Delete",
    "voltorb-hisui": "voltorb-hisui",
    "vulpix-alola": "vulpix-alola",
    "walking-wake": "walking-wake",
    "weezing-galar": "weezing-galar",
    "wishiwashi-school": "wishiwashi-school",
    "wishiwashi-solo": "wishiwashi-school",
    "wo-chien": "wo-chien",
    "wooper-paldea": "wooper-paldea",
    "wormadam-plant": "wormadam-plant",
    "wormadam-sandy": "wormadam-sandy",
    "wormadam-trash": "wormadam-trash",
    "yamask-galar": "yamask-galar",
    "zacian-crowned": "zacian-crowned",
    "zamazenta-crowned": "zamazenta-crowned",
    "zapdos-galar": "zapdos-galar",
    "zarude-dada": "Zarude",
    "zigzagoon-galar": "zigzagoon-galar",
    "zoroark-hisui": "zoroark-hisui",
    "zorua-hisui": "zorua-hisui",
    "zygarde-10": "zygarde-50",
    "zygarde-10-power-construct": "zygarde-50",
    "zygarde-50": "zygarde-50",
    "zygarde-50-power-construct": "zygarde-50",
    "zygarde-complete": "zygarde-50",
}


FORM_COLLAPSE_MAP = {k.lower(): v.lower() for k,v in FORM_COLLAPSE_MAP.items()}

FORMS_BY_BASE = defaultdict(list)
for form in FORMS:
    key = form['key']
    base = key.split('-', 1)[0]
    FORMS_BY_BASE[base].append(form)

def normalize_form_key(raw_key, form_by_key, suffixes):
    raw = raw_key.lower()
    if raw in form_by_key:
        return raw
    if '-' in raw:
        base, suffix = raw.split('-',1)
        if base in form_by_key and suffix not in suffixes:
            return base
    return raw

def resolve_form_key(raw_key, form_by_key, forms_by_base, suffixes):
    raw = raw_key.lower().strip()

    # 1) explicit override
    if raw in FORM_COLLAPSE_MAP:
        return FORM_COLLAPSE_MAP[raw]

    # 2) exact form-key
    if raw in form_by_key:
        return raw

    # 3) drop cosmetic suffixes
    base, *suf = raw.split('-', 1)
    if suf and base in form_by_key and suf[0] not in suffixes:
        return base

    # 4) if they typed just the species, pick a default variety
    if '-' not in raw and raw in forms_by_base:
        return raw if raw in form_by_key else forms_by_base[raw][0]['key']

    return None